---
- name: Install httpd
  yum: name=httpd


- name: drop u from IUS package name
  set_fact:
    php_package_name_extra: "{{ php_version }}"
  when: php_enablerepo == "ius" and php_version >= 73 and php_package_name_extra == (php_version ~ "u")
- name: install mod_php
  yum: 
    name: mod_php{{ php_package_name_extra }}
    enablerepo: "{{ php_enablerepo }}"

- name: Upload /etc/httpd
  copy:
    src: files/web/etc/httpd/
    dest: /etc/httpd/

- name: Removing default httpd "Listen 80"
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: ^Listen 80$
    state: absent

- name: Configuring /var/www/html "AllowOverride All"
  command: >-
    perl -0777 -pi
      -e 's#(<Directory "/var/www/html">.*?)AllowOverride None(.*?</Directory>)#$1AllowOverride All$2#s'
      /etc/httpd/conf/httpd.conf

- name: Add apache to groups
  user:
    name: apache
    groups:
      - vagrant
    append: yes

- name: Add vagrant to apache group
  user:
    name: vagrant
    groups:
      - apache
    append: yes

- name: Start httpd service
  service: name=httpd state=started enabled=yes
